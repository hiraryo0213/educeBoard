!function(t){function e(t){var e,a,n=["ms","webkit","moz"],i={},s=n.length;for(e in t){for(a=0;s>a;a++)i["-"+n[a]+"-"+e]=t[e];i[e]=t[e]}return i}var a="commentSyncScroll";animationendEvent="webkitAnimationEnd."+a+" MSAnimationEnd."+a+" animationend."+a;var n={initialize:function(e){return this.each(function(){t(this).data(a,t.extend(!0,{nowClass:"elNowComment",$sendParts:null,$viewParts:null,sendPartsAttr:"sendArea",viewPartsAttr:"viewArea",viewAreaHeight:null,$timer:t('#Player [data-unitysyncdata-parts="timeView"]'),nowTime:0,$commentsDOM:null,commentArray:[],educeboardBasicInfo:t("body").data("educeboardBasicInfo"),$textbox:t(this).find("[data-"+a+'-parts="textbox"]'),$submit:t(this).find("[data-"+a+'-parts="submit"]'),nowHeight:0,$checkbox:t(this).find("[data-"+a+'-parts="isSyncScroll"]'),isSyncScroll:!0,syncScrollClass:"elSyncScroll",commentClass:"elComment",userClass:"elUser",timestampClass:"elTimeStamp",commentAddClass:"elAdded",addedAnimationName:"addedCommentAnimation",sendURL:"http://pb.fm.senshu-u.ac.jp/~tmochi/educeboard/insertComments.php",sendData:{},commentAdded:!1},e));var i=t(this),s=i.data(a);s.isSyncScroll=s.$checkbox.prop("checked"),s.$sendParts=i.find("[data-"+a+'-parts="'+s.sendPartsAttr+'"]'),s.$viewParts=i.find("[data-"+a+'-parts="'+s.viewPartsAttr+'"]'),s.$viewParts.toggleClass(s.syncScrollClass,s.isSyncScroll),s.viewAreaHeight=s.$viewParts.innerHeight(),s.$commentsDOM=s.$viewParts.find("[data-"+a+"-timestamp]");var o;s.$commentsDOM.each(function(){o=t(this),s.commentArray.push({$comment:o,time:parseInt(o.attr("data-"+a+"-timestamp")),height:o.outerHeight()})}),n.setEvent.apply(i)})},setEvent:function(){var i,s=t(this),o=s.data(a),r=o.$textbox,l=o.$submit,m=o.$checkbox;l.on("click."+a,function(t){return t.preventDefault(),i=r.val(),void 0===i||""===i||null===i?!1:void n.sendComment.apply([s,i])}),m.on("click."+a,function(){var a=t(this);o.isSyncScroll=a.prop("checked"),o.$viewParts.toggleClass(o.syncScrollClass,o.isSyncScroll),o.isSyncScroll?o.$viewParts.children().css(e({transform:"translateY("+-1*o.$viewParts.scrollTop()+"px)"})).delay(1).queue(function(){o.$viewParts.scrollTop(0),o.$viewParts.children().css(e({transform:"translateY("+o.nowHeight+"px)",transition:""})).dequeue()}):(o.$viewParts.children().css(e({transform:"",transition:"none"})),o.$viewParts.scrollTop(-1*o.nowHeight),o.$viewParts.animate({scrollTop:-1*o.nowHeight},"fast"))})},commentSync:function(){var n,i=t(this),s=i.data(a),o=!1,r=[],l=[],m=0;s.nowTime=s.$timer.attr("data-unitySyncData-time"),n=parseInt(s.nowTime);var c,d,h=s.commentArray,p=h.length;for(c=0;p>c;c++)if(l.push(h[c]),n===h[c].time){for(r.push(h[c]),d=c+1;p>d&&n==h[d].time;d++)l.push(h[d]),r.push(h[d]);o=!0;break}var u=r.length,f=l.length,v=0;if(o){for(s.$commentsDOM.toggleClass(s.nowClass,!1),c=0;u>c;c++)r[c].$comment.toggleClass(s.nowClass,!0);for(c=f-1;c>=0;c--)if(v-=l[c].height,-1*s.viewAreaHeight>v){for(d=0;c>=d;d++)m-=l[d].height;s.isSyncScroll&&s.$viewParts.children().css(e({transform:"translateY("+m+"px)"})),s.nowHeight=m;break}}},sendComment:function(){var e,i,s=t(this[0]),o=this[1],r=s.data(a),l=r.$textbox,m=parseInt(r.$timer.attr("data-unitySyncData-time")),c=r.educeboardBasicInfo,d=r.commentArray,h=d.length,p=[0,0,0],u=!1;t.ajax({type:"POST",url:r.sendURL,data:{uid:c.uid,session_id:c.sid,tid:c.tid,time:m,comments:this[1]}}).done(function(){for(l.val(""),e=0;h>e;e++){if(m<=d[e].time&&e+1!==d.length){u=!1,i=e;break}u=!0,i=d.length-1}p[2]=m,p[1]=parseInt(p[2]/60),p[0]=parseInt(p[1]/60),p[1]=p[1]-60*p[0],p[2]=p[2]-60*p[1];var c="",f=p.length;for(e=0;f>e;e++)p[e]<10&&(p[e]="0"+p[e]),c+=p[e],e!=f-1&&(c+=":");var v=t("<li>").attr("data-"+a+"-timestamp",m).toggleClass(r.commentAddClass,!0),g=t("<dl />"),y=t("<dt />").toggleClass(r.commentClass,!0).text(o),$=t("<dd />").toggleClass(r.userClass,!0).text(r.educeboardBasicInfo.uname),w=t("<dd />").toggleClass(r.timestampClass,!0).text(c);g.append(y).append($).append(w),v.append(g),u?(d[i].$comment.after(v),d.push({$comment:v,time:m,height:v.outerHeight()})):(d[i].$comment.before(v),d.splice(i,0,{$comment:v,time:m,height:v.outerHeight()})),v.on(animationendEvent,function(t){v.off(animationendEvent),t.originalEvent.animationName===r.addedAnimationName&&v.toggleClass(r.commentAddClass,!1)}),r.$commentsDOM=r.$viewParts.find("[data-"+a+"-timestamp]"),r.commentArray=d,n.commentSync.apply(s)}).fail(function(){})},applyCallback:function(){var e=t(this)[0],n=e.data(a),i=t(this)[1];"function"==typeof n[i]&&n[i]()},destroy:function(){}};t.fn[a]=function(t){return n[t]?n[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void 0:n.initialize.apply(this,arguments)}}(jQuery);